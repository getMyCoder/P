<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="canvasDiv" style="width: 90%;height: 90vh;border:1px solid #ccc"></div>
<script type="text/javascript">

    function CustomTree() {
        // id
        this.id = null
        this.canvasId = null
        // 画布尺寸
        this.size = {
            width: null,
            height: null,
            cW: null,
            cH: null,
        }

        // canvas、ctx
        this.canvas = null
        this.ctx = null

        // cache-canvas、cache-ctx
        this.canvasCache = null
        this.ctxCache = null

        // model
        this.modelData = {
            /*label: '',
            id: '0',
            children: [
                {
                    label: '项目支撑材料',
                    id: '0-1',
                    color: '#3b84f3',
                    fontSize: 16,
                    children: [
                        {
                            label: '投资主体财务报表',
                            id: '0-1-1',
                            fontSize: 14,
                            color: '#3b84f3',
                            children: [
                                {
                                    label: 'SSSSS',
                                    id: '0-1-1SSSSSSS',
                                    fontSize: 14,
                                    color: '#3b84f3'
                                }
                            ]
                        },
                        {
                            label: '标的公司财务报表',
                            id: '0-1-2',
                            fontSize: 14,
                            color: '#3b84f3',
                        },
                        {
                            label: '资产评估报告',
                            id: '0-1-3',
                            color: '#3b84f3',
                            fontSize: 14
                        },
                        {
                            label: '风险评估报告',
                            id: '0-1-4',
                            color: '#3b84f3',
                            fontSize: 14
                        },
                        {
                            label: '社会稳定风险评估报告',
                            id: '0-1-5',
                            color: '#3b84f3',
                            fontSize: 14
                        }
                    ]
                },
                {
                    label: '项目决策及批复文件材料',
                    id: '0-2',
                    color: '#fbbc00',
                    fontSize: 16,
                    children: [
                        {
                            label: '各级单位决策文件',
                            id: '0-2-1',
                            color: '#fbbc00',
                            fontSize: 14
                        },
                        {
                            label: '律师事务所出具法律意见书',
                            id: '0-2-2',
                            color: '#fbbc00',
                            fontSize: 14
                        },
                        {
                            label: '项目批复文件',
                            id: '0-2-3',
                            color: '#fbbc00',
                            fontSize: 14
                        }
                    ]
                },
                {
                    label: '项目可研报告及评审材料',
                    id: '0-3',
                    color: '#33ab51',
                    fontSize: 16,
                    children: [
                        {
                            label: '行业市场分析',
                            id: '0-3-1',
                            color: '#33ab51',
                            fontSize: 14
                        },
                        {
                            label: '项目建议书',
                            id: '0-3-2',
                            color: '#33ab51',
                            fontSize: 14
                        },
                        {
                            label: '可研报告',
                            id: '0-3-3',
                            color: '#33ab51',
                            fontSize: 14
                        },
                        {
                            label: '可研评审会文档',
                            id: '0-3-4',
                            color: '#33ab51',
                            fontSize: 14
                        },
                        {
                            label: '集团专家评审报告',
                            id: '0-3-5',
                            color: '#33ab51',
                            fontSize: 14
                        },
                        {
                            label: '集团业务部门会签材料',
                            id: '0-3-6',
                            color: '#33ab51',
                            fontSize: 14
                        }
                    ]
                },
                {
                    label: '合同协议类材料',
                    id: '0-4',
                    color: '#488bfe',
                    fontSize: 16,
                    children: [
                        {
                            label: '专业服务机构聘用合同',
                            id: '0-4-1',
                            fontSize: 14,
                            color: '#488bfe',
                            children: [
                                {
                                    id: 1111,
                                    label: '1111',
                                    fontSize: 14,
                                    color: '#488bfe',
                                    children: [
                                        {
                                            id: 2222222,
                                            label: '222222',
                                            color: '#488bfe',
                                            fontSize: 14
                                        },
                                        {
                                            id: 2222222,
                                            label: '222222',
                                            color: '#488bfe',
                                            fontSize: 14
                                        },
                                        {
                                            id: 2222222,
                                            label: '222222',
                                            color: '#488bfe',
                                            fontSize: 14
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            label: '投资协议',
                            id: '0-4-2',
                            color: '#488bfe',
                            fontSize: 14
                        },
                        {
                            label: '交易方确认函',
                            id: '0-4-3',
                            color: '#488bfe',
                            fontSize: 14
                        },
                        {
                            label: '补充协议',
                            id: '0-4-4',
                            color: '#488bfe',
                            fontSize: 14
                        },
                        {
                            label: '合作意向书',
                            id: '0-4-5',
                            color: '#488bfe',
                            fontSize: 14
                        }
                    ]
                },
                {
                    label: '公司治理类材料',
                    id: '0-6',
                    color: '#ec0404',
                    fontSize: 16,
                    children: [
                        {
                            label: '公司章程',
                            id: '0-6-1',
                            color: '#ec0404',
                            fontSize: 14
                        },
                        {
                            label: '董监高任命文件',
                            id: '0-6-2',
                            color: '#ec0404',
                            fontSize: 14
                        },
                        {
                            label: '三会的会议文件',
                            id: '0-6-3',
                            color: '#ec0404',
                            fontSize: 14
                        }
                    ]
                },
                {
                    label: '项目后评价材料',
                    id: '0-7',
                    color: '#6f56e6',
                    fontSize: 16,
                    children: [
                        {
                            label: '自评价报告',
                            id: '0-7-1',
                            color: '#6f56e6',
                            fontSize: 14
                        },
                        {
                            label: '后评价报告',
                            id: '0-7-2',
                            color: '#6f56e6',
                            fontSize: 14
                        }
                    ]
                }
            ]*/
        }
        this.deepData=null

        // 数据节点个数统计
        this.nodeStatistics = {
            _left: {
                _s: 0,
                _o: {},
                _levle: 0
            },
            _right: {
                _s: 0,
                _o: {},
                _levle: 0
            }
        }


    }

    CustomTree.prototype = {
        // 初始化
        init: function (id) {
            this.id = id

            // 初始化画布
            this.initCanvas()

            return {
                setOption:this.setOption.bind(this),
                resize:this.resize.bind(this),
            }

        },
        resize:function(){
            if (this.canvasId && this.id && document.getElementById(this.canvasId) && document.getElementById(this.id)){
                document.getElementById(this.id).removeChild(document.getElementById(this.canvasId))

                // 初始化画布
                this.initCanvas()

                // 加载数据
                this.setOption()
            }
        },
        // 加入数据
        setOption: function (data) {
            if (!this.deepData){
                this.deepData=JSON.parse(JSON.stringify(data))
            }

            // 初始化数据
            this.nodeStatistics = {
                _left: {
                    _s: 0,
                    _o: {},
                    _levle: 0
                },
                _right: {
                    _s: 0,
                    _o: {},
                    _levle: 0
                }
            }
            this.modelData = JSON.parse(JSON.stringify(this.deepData))

            // 处理数据
            this.handleModel()

            // 缓存机制绘制
            this.initDraw()

        },
        // 初始化画布
        initCanvas: function () {
            // 创建标签
            var currentCanvas = document.createElement('canvas')
            var currentDocument = document.getElementById(this.id)
            currentCanvas.width = currentDocument.offsetWidth
            currentCanvas.height = currentDocument.offsetHeight
            currentCanvas.id = new Date().getTime() + '_canvas'
            this.canvasId=currentCanvas.id
            currentDocument.appendChild(currentCanvas)
            this.size.width = currentDocument.offsetWidth
            this.size.height = currentDocument.offsetHeight
            this.size.cW = currentDocument.offsetWidth - 50
            this.size.cH = currentDocument.offsetHeight - 50

            // 获取canvas
            this.canvas = document.getElementById(currentCanvas.id)
            this.canvas.width = this.size.width
            this.canvas.height = this.size.height
            this.ctx = this.canvas.getContext('2d')

            // 创建缓存画布
            this.canvasCache = document.createElement('canvas')
            this.canvasCache.width = this.size.width
            this.canvasCache.height = this.size.height
            this.ctxCache = this.canvasCache.getContext('2d')

        },
        // 缓存机制绘制
        initDraw: function () {
            this.ctx.clearRect(0, 0, this.size.width, this.size.height)
            this.ctxCache.clearRect(0, 0, this.size.width, this.size.height)
            // 缓存机制绘制
            this.drawCanvas()
        },
        // 绘制页面
        drawCanvas: function () {
            // 绘制
            this.drawItem(this.modelData.children)

            // 画布绘制
            this.ctx.drawImage(this.canvasCache, 0, 0, this.size.width, this.size.height)

        },
        // 数据处理
        handleModel: function () {
            // 统计子节点
            this.statistics(this.modelData.children, 1, [])

            // 设置坐标
            this.setCoordinate(this.modelData.children)

            console.log(this.modelData.children);
            console.log(this.nodeStatistics);

        },
        // 统计子节点
        statistics: function (itemList, level, root) {

            // 统计
            for (var j = root.length - 1; j >= 0; j--) {
                if (root[j - 1]) {
                    if (j === root.length - 1) {
                        root[j]._s = root[j]._cs
                        root[j - 1]._s = root[j - 1]._cs + root[j]._cs
                    } else {
                        root[j - 1]._s = root[j - 1]._cs + root[j]._s
                    }
                    root[j - 1]._falge = true
                } else {
                    if (!root[j]._falge) {
                        root[j]._s = root[j]._cs
                    }
                }
            }

            // 统计deep-level
            if (root && root.length > 0) {
                root[0]._mLevel = level > root[0]._mLevel ? level : root[0]._mLevel
            }

            // for
            for (var i = 0; i < itemList.length; i++) {
                // // level
                itemList[i]._level = level
                itemList[i]._cs = 0
                itemList[i]._s = 0
                itemList[i]._falge = false
                itemList[i].color = itemList[i].color ? itemList[i].color : '#000'

                // 统计设置deep-level
                if (level === 1) {
                    itemList[i]._mLevel = level
                }

                // 去除同级节点
                for (var k = 0; k < root.length; k++) {
                    if (root[k]._level === level) {
                        root.splice(k, root.length)
                        k -= root.length
                    }
                }

                // 是否有子模块
                if (itemList[i].children && itemList[i].children.length > 0) {
                    itemList[i]._cs = itemList[i].children.length + (level === 1 ? 1 : 0)
                    // 添加当前节点
                    root.push(itemList[i])

                    this.statistics(itemList[i].children, level + 1, root)
                }

                // left | right
                if (level === 1) {
                    itemList[i]._s=itemList[i]._s?itemList[i]._s:1
                    if (i % 2 === 0) {
                        this.nodeStatistics._left._s += itemList[i]._s
                        this.nodeStatistics._left._o[itemList[i].id] = itemList[i]
                        this.nodeStatistics._left._levle = this.nodeStatistics._left._levle < itemList[i]._mLevel ? itemList[i]._mLevel : this.nodeStatistics._left._levle
                    } else {
                        this.nodeStatistics._right._s += itemList[i]._s
                        this.nodeStatistics._right._o[itemList[i].id] = itemList[i]
                        this.nodeStatistics._right._levle = this.nodeStatistics._right._levle < itemList[i]._mLevel ? itemList[i]._mLevel : this.nodeStatistics._right._levle
                    }
                }

            }
        },
        // 设置坐标
        setCoordinate: function (itemList, itemPar) {
            for (var i = 0; i < itemList.length; i++) {

                if (itemList[i]._level === 1) {
                    // 一级数据
                    if (i % 2 === 0) {
                        // left
                        itemList[i].style = {
                            type: 'left',
                            height: parseInt((itemList[i]._s / this.nodeStatistics._left._s) * this.size.cH),
                            index: i / 2,
                            y: (i > 0 ? (itemList[i - 2].style.height + itemList[i - 2].style.y) : 30)
                        }
                    } else {
                        // right
                        itemList[i].style = {
                            type: 'right',
                            height: parseInt(itemList[i]._s / this.nodeStatistics._right._s * this.size.cH),
                            index: (i + 1) / 2,
                            y: (i > 1 ? (itemList[i - 2].style.height + itemList[i - 2].style.y) : 30)
                        }
                    }
                } else {
                    // 大于等于二级数据
                    itemList[i].style = {
                        type: itemPar.style.type,
                        height: parseInt((itemList[i]._s + 1) / this.nodeStatistics._left._s * this.size.cH),
                        y: (i > 0 ? (itemList[i - 1].style.height + itemList[i - 1].style.y) : itemPar.style.y + 30),
                        startY: itemPar.style.y + 20
                    }
                }
                // 递归
                if (itemList[i].children && itemList[i].children.length > 0) {
                    this.setCoordinate(itemList[i].children, itemList[i])
                }
            }

        },
        // 绘制
        drawItem: function (dataList) {
            for (var i = 0; i < dataList.length; i++) {
                var item = dataList[i]
                if (item._level === 1) {
                    // 一级
                    var start = {
                        x: this.size.width * 0.5,
                        y: this.size.height
                    }
                    var end = {
                        x: this.size.width * 0.5,
                        y: this.size.height - item.style.y,
                    }
                    var other = {
                        offset: 100,
                        index: item.style.index / (this.modelData.children.length * 0.5),
                        line: 0,
                        textAlign: 'center',
                    }
                    var dir = 0

                    if (item.style.type === 'left') {
                        dir = 1
                        other.line = this.size.width * 0.5 / this.nodeStatistics._left._levle
                        other.textAlign = 'right'
                    } else {
                        dir = -1
                        other.line = this.size.width * 0.5 / this.nodeStatistics._right._levle
                        other.textAlign = 'left'
                    }
                    other.offset = other.offset * dir
                    this.drawConnect(item, start, end, other, dir, item.color)

                } else {
                    // 等于等于二级的数据结构
                    this.categoryMore(item)
                }

                // 递归
                if (item.children && item.children.length > 0) {
                    this.drawItem(item.children)
                }
            }
        },
        // 一级 | 绘制连接
        drawConnect: function (item, start, end, other, dir, color) {
            // 展开方式
            var cTW = 6
            this.ctxCache.beginPath()
            this.ctxCache.strokeStyle = color
            this.ctxCache.fillStyle = color
            this.ctxCache.moveTo(start.x - cTW + 0.5, start.y)
            this.ctxCache.quadraticCurveTo(start.x + 0.5, end.y + 5 + other.index * (other.offset + 120), end.x - other.offset, end.y)

            this.ctxCache.quadraticCurveTo(start.x + 0.5, end.y + (4.5 - 10.5 * dir) + other.index * (other.offset + 120), start.x + 0.5 + cTW, start.y)
            this.ctxCache.lineTo(start.x - cTW + 0.5, start.y)

            this.ctxCache.stroke()
            this.ctxCache.fill()
            this.ctxCache.closePath()

            // label | line
            this.ctxCache.beginPath()
            this.ctxCache.strokeStyle = color
            this.ctxCache.fillStyle = color
            this.ctxCache.font = item.fontSize + 'px 微软雅黑'
            this.ctxCache.moveTo(end.x - other.offset, end.y)
            // this.ctxCache.lineTo(end.x - other.offset - other.line * dir, end.y)
            this.ctxCache.lineTo(end.x - other.offset - (item.label.length*15+15) * dir, end.y)
            this.ctxCache.moveTo(end.x - other.offset, end.y)
            this.ctxCache.textAlign = other.textAlign
            this.ctxCache.fillText(item.label, end.x - other.offset - 5 * dir, end.y - 5)
            this.ctxCache.stroke()
            this.ctxCache.fill()
            this.ctxCache.closePath()
        },
        // 大于等于二级的树
        categoryMore: function (item) {
            this.ctxCache.beginPath()
            this.ctxCache.strokeStyle = item.color
            // this.ctxCache.fillStyle = item.color
            var dir = 1
            var curObj = {}
            if (item.style.type === 'left') {
                dir = -1
                curObj.textAlign = 'right'
            } else {
                dir = 1
                curObj.textAlign = 'left'
            }


            var curXY = {
                mx: this.size.width * 0.5 + 100 * dir + (item._level - 1) * 30 * dir + (item._level - 2) * 30 * dir,
                my: this.size.height - item.style.startY,
                sy: this.size.height - item.style.y,
                ey: this.size.height - item.style.y,
            }
            curXY.sx = curXY.mx + 30 * dir
            // curXY.ex = curXY.sx + (this.size.width * 0.5 / (this.nodeStatistics._left._levle * 0.8)) * dir
            curXY.ex = curXY.sx + (item.label.length*15+15) * dir

            this.ctxCache.moveTo(curXY.mx, curXY.my)
            this.ctxCache.quadraticCurveTo(
                curXY.mx,
                this.size.height - item.style.y,
                curXY.sx,
                curXY.sy,
            )
            this.ctxCache.lineTo(curXY.ex, curXY.ey)

            this.ctxCache.stroke()
            this.ctxCache.closePath()

            // label
            this.ctxCache.beginPath()
            this.ctxCache.fillStyle = item.color
            this.ctxCache.font = item.fontSize + 'px 微软雅黑'
            this.ctxCache.moveTo(curXY.sx, curXY.sy)
            this.ctxCache.textAlign = curObj.textAlign
            this.ctxCache.fillText(item.label, curXY.sx + 5 * dir, curXY.sy - 5)
            this.ctxCache.fill()
            this.ctxCache.closePath()
        }
    }

    function GTree(id) {
        var customTree = new CustomTree()
        return customTree.init(id)
    }

    var option = {
        label: '',
        id: '0',
        children: [
            {
                label: '一级文档',
                id: '0-1',
                color: '#3b84f3',
                fontSize: 16,
                children: [
                    {
                        label: '一级文档-01',
                        id: '0-1-1',
                        fontSize: 14,
                        color: '#3b84f3'
                    },
                    {
                        label: '一级文档-02',
                        id: '0-1-2',
                        fontSize: 14,
                        color: '#3b84f3',
                    },
                    {
                        label: '一级文档-03',
                        id: '0-1-3',
                        color: '#3b84f3',
                        fontSize: 14
                    },
                    {
                        label: '一级文档-04',
                        id: '0-1-4',
                        color: '#3b84f3',
                        fontSize: 14
                    },
                    {
                        label: '一级文档-05',
                        id: '0-1-5',
                        color: '#3b84f3',
                        fontSize: 14
                    }
                ]
            },
            {
                label: '二级文档',
                id: '0-2',
                color: '#fbbc00',
                fontSize: 16,
                children: [
                    {
                        label: '二级文档-01',
                        id: '0-2-1',
                        color: '#fbbc00',
                        fontSize: 14
                    },
                    {
                        label: '二级文档-02',
                        id: '0-2-2',
                        color: '#fbbc00',
                        fontSize: 14
                    },
                    {
                        label: '二级文档-03',
                        id: '0-2-3',
                        color: '#fbbc00',
                        fontSize: 14
                    }
                ]
            },
            {
                label: '三级文档',
                id: '0-3',
                color: '#33ab51',
                fontSize: 16,
                children: [
                    {
                        label: '三级文档-01',
                        id: '0-3-1',
                        color: '#33ab51',
                        fontSize: 14
                    },
                    {
                        label: '三级文档-02',
                        id: '0-3-2',
                        color: '#33ab51',
                        fontSize: 14
                    },
                    {
                        label: '三级文档-03',
                        id: '0-3-3',
                        color: '#33ab51',
                        fontSize: 14
                    },
                    {
                        label: '三级文档-04',
                        id: '0-3-4',
                        color: '#33ab51',
                        fontSize: 14
                    },
                    {
                        label: '三级文档-05',
                        id: '0-3-5',
                        color: '#33ab51',
                        fontSize: 14
                    },
                    {
                        label: '三级文档-06',
                        id: '0-3-6',
                        color: '#33ab51',
                        fontSize: 14
                    }
                ]
            },
            {
                label: '四级文档',
                id: '0-4',
                color: '#488bfe',
                fontSize: 16,
                children: [
                    {
                        label: '四级文档-01',
                        id: '0-4-1',
                        fontSize: 14,
                        color: '#488bfe'
                    },
                    {
                        label: '四级文档-02',
                        id: '0-4-2',
                        color: '#488bfe',
                        fontSize: 14
                    },
                    {
                        label: '四级文档-03',
                        id: '0-4-3',
                        color: '#488bfe',
                        fontSize: 14
                    },
                    {
                        label: '四级文档-04',
                        id: '0-4-4',
                        color: '#488bfe',
                        fontSize: 14
                    },
                    {
                        label: '四级文档-05',
                        id: '0-4-5',
                        color: '#488bfe',
                        fontSize: 14
                    }
                ]
            },
            {
                label: '五级文档',
                id: '0-6',
                color: '#ec0404',
                fontSize: 16,
                children: [
                    {
                        label: '五级文档-01',
                        id: '0-6-1',
                        color: '#ec0404',
                        fontSize: 14
                    },
                    {
                        label: '五级文档-02',
                        id: '0-6-2',
                        color: '#ec0404',
                        fontSize: 14
                    },
                    {
                        label: '五级文档-03',
                        id: '0-6-3',
                        color: '#ec0404',
                        fontSize: 14
                    }
                ]
            },
            {
                label: '六级文档',
                id: '0-7',
                color: '#6f56e6',
                fontSize: 16,
                children: [
                    {
                        label: '六级文档-01',
                        id: '0-7-1',
                        color: '#6f56e6',
                        fontSize: 14
                    },
                    {
                        label: '六级文档-02',
                        id: '0-7-2',
                        color: '#6f56e6',
                        fontSize: 14
                    }
                ]
            }
        ]
    }

    const gTree = GTree('canvasDiv')
    gTree.setOption(option)
    window.addEventListener('resize', () => {
        gTree.resize()
    })

</script>

</body>
</html>